osboxes@osboxes:~$ curl -v -H "Accept: application/json" http://localhost:3000/.account/
{
//   HERE
    "controls": {
        "password": {
            "login": "http://localhost:3000/.account/login/password/",
// 
            "forgot": "http://localhost:3000/.account/login/password/forgot/",
            "reset": "http://localhost:3000/.account/login/password/reset/"
        },
        "main": {
            "logins": "http://localhost:3000/.account/login/",
            "index": "http://localhost:3000/.account/"
        },
        "account": {
            "create": "http://localhost:3000/.account/account/"
        },
        "html": {
            "password": {
                "register": "http://localhost:3000/.account/login/password/register/",
                "login": "http://localhost:3000/.account/login/password/",
                "forgot": "http://localhost:3000/.account/login/password/forgot/"
            },
            "main": {
                "login": "http://localhost:3000/.account/login/"
            }
        }
    },
    "version": "0.5"
}


curl -X POST -H "Accept: application/json" \
-H "Content-type: application/json" \
-d '{ \
    "email": "my@email.com", \
    "password": "password" \
}'  \
http://localhost:3000/.account/login/password/


{
// HERE
    "authorization": "cf46943e-e32f-4f11-baf7-f045dd0f977e",
// 
    "controls": {
        "password": {
            "login": "http://localhost:3000/.account/login/password/",
            "forgot": "http://localhost:3000/.account/login/password/forgot/",
            "reset": "http://localhost:3000/.account/login/password/reset/"
        },
        "main": {
            "logins": "http://localhost:3000/.account/login/",
            "index": "http://localhost:3000/.account/"
        },
        "account": {
            "create": "http://localhost:3000/.account/account/"
        },
        "html": {
            "password": {
                "register": "http://localhost:3000/.account/login/password/register/",
                "login": "http://localhost:3000/.account/login/password/",
                "forgot": "http://localhost:3000/.account/login/password/forgot/"
            },
            "main": {
                "login": "http://localhost:3000/.account/login/"
            }
        }
    },
    "version": "0.5"
}



curl -X GET \
-H "Authorization: CSS-Account-Token cf46943e-e32f-4f11-baf7-f045dd0f977e" \
http://localhost:3000/.account/


{
    "controls": {
        "password": {
            "login": "http://localhost:3000/.account/login/password/",
            "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
            "forgot": "http://localhost:3000/.account/login/password/forgot/",
            "reset": "http://localhost:3000/.account/login/password/reset/"
        },
        "main": {
            "logins": "http://localhost:3000/.account/login/",
            "index": "http://localhost:3000/.account/"
        },
        "account": {
            "webId": "http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/webid/",
            "pod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
            //   HERE
            "clientCredentials": "http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/client-credentials/",
            // 
            "create": "http://localhost:3000/.account/account/",
            "logout": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/logout/"
        },
        "html": {
            "password": {
                "register": "http://localhost:3000/.account/login/password/register/",
                "login": "http://localhost:3000/.account/login/password/",
                "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
                "forgot": "http://localhost:3000/.account/login/password/forgot/"
            },
            "main": {
                "login": "http://localhost:3000/.account/login/"
            },
            "account": {
                "linkWebId": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/webid/",
                "createPod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
                "createClientCredentials": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/client-credentials/",
                "account": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/"
            }
        }
    },
    "version": "0.5"
}




curl -X GET  \
-H "Authorization: CSS-Account-Token cf46943e-e32f-4f11-baf7-f045dd0f977e"  \
http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/webid/


{
    "fields": {
        "webId": {
            "required": true,
            "type": "string"
        }
    },
// HERE
    "webIdLinks": {
        "http://localhost:3000/markw/profile/card#me": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/webid/74abd804-301d-4cd6-823c-89b3408aa723/"
// 
    },
    "controls": {
        "password": {
            "login": "http://localhost:3000/.account/login/password/",
            "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
            "forgot": "http://localhost:3000/.account/login/password/forgot/",
            "reset": "http://localhost:3000/.account/login/password/reset/"
        },
        "main": {
            "logins": "http://localhost:3000/.account/login/",
            "index": "http://localhost:3000/.account/"
        },
        "account": {
            "webId": "http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/webid/",
            "pod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
//  and here
            "clientCredentials": "http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/client-credentials/",
// 
            "create": "http://localhost:3000/.account/account/",
            "logout": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/logout/"
        },
        "html": {
            "password": {
                "register": "http://localhost:3000/.account/login/password/register/",
                "login": "http://localhost:3000/.account/login/password/",
                "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
                "forgot": "http://localhost:3000/.account/login/password/forgot/"
            },
            "main": {
                "login": "http://localhost:3000/.account/login/"
            },
            "account": {
                "linkWebId": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/webid/",
                "createPod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
                "createClientCredentials": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/client-credentials/",
                "account": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/"
            }
        }
    },
    "version": "0.5"
}



curl -X POST \
-H "Accept: application/json" \
-H "Content-type: application/json" \
-H "Authorization: CSS-Account-Token cf46943e-e32f-4f11-baf7-f045dd0f977e" \
-d '{
    "name": "my-token",
    "webId": "http://localhost:3000/markw/profile/card#me"
}' \
"http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/client-credentials/"



{
//  HERE
    "id": "my-token_4141776e-b7ab-4d16-9be4-8062535f7e05",
    "secret": "39f45dbe76ba16db7f338a75f2978b759c0dfeef9ca5a72bd4c9414ea054144982b7a4145581e6c8d714ca166fce135c550c58233f5242c68f6ccc141657b8a7",
    "resource": "http://localhost:3000/.account/account/d821264d-3c88-467d-ab3b-c49288ebb53a/client-credentials/a206a3dd-affc-4195-a53b-4dd442b1c129/",
// 
    "controls": {
        "password": {
            "login": "http://localhost:3000/.account/login/password/",
            "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
            "forgot": "http://localhost:3000/.account/login/password/forgot/",
            "reset": "http://localhost:3000/.account/login/password/reset/"
        },
        "main": {
            "logins": "http://localhost:3000/.account/login/",
            "index": "http://localhost:3000/.account/"
        },
        "account": {
            "webId": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/webid/",
            "pod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
            "clientCredentials": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/client-credentials/",
            "create": "http://localhost:3000/.account/account/",
            "logout": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/logout/"
        },
        "html": {
            "password": {
                "register": "http://localhost:3000/.account/login/password/register/",
                "login": "http://localhost:3000/.account/login/password/",
                "create": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/login/password/",
                "forgot": "http://localhost:3000/.account/login/password/forgot/"
            },
            "main": {
                "login": "http://localhost:3000/.account/login/"
            },
            "account": {
                "linkWebId": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/webid/",
                "createPod": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/",
                "createClientCredentials": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/client-credentials/",
                "account": "http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/"
            }
        }
    },
    "version": "0.5"
}




get the token endpoint:
curl -v http://localhost:3000/.well-known/openid-configuration
{
    "authorization_endpoint": "http://localhost:3000/.oidc/auth",
    "claims_parameter_supported": true,
    "claims_supported": [
        "azp",
        "sub",
        "webid",
        "sid",
        "auth_time",
        "iss"
    ],
    "code_challenge_methods_supported": [
        "S256"
    ],
    "end_session_endpoint": "http://localhost:3000/.oidc/session/end",
    "grant_types_supported": [
        "implicit",
        "authorization_code",
        "refresh_token",
        "client_credentials"
    ],
    "issuer": "http://localhost:3000/",
    "jwks_uri": "http://localhost:3000/.oidc/jwks",
    "registration_endpoint": "http://localhost:3000/.oidc/reg",
    "authorization_response_iss_parameter_supported": true,
    "response_modes_supported": [
        "form_post",
        "fragment",
        "query"
    ],
    "response_types_supported": [
        "code id_token",
        "code",
        "id_token",
        "none"
    ],
    "scopes_supported": [
        "openid",
        "profile",
        "offline_access",
        "webid"
    ],
    "subject_types_supported": [
        "public"
    ],
    "token_endpoint_auth_methods_supported": [
        "client_secret_basic",
        "client_secret_jwt",
        "client_secret_post",
        "private_key_jwt",
        "none"
    ],
    "token_endpoint_auth_signing_alg_values_supported": [
        "HS256",
        "RS256",
        "PS256",
        "ES256",
        "EdDSA"
    ],
//   HERE
    "token_endpoint": "http://localhost:3000/.oidc/token",
// 
    "id_token_signing_alg_values_supported": [
        "ES256"
    ],
    "pushed_authorization_request_endpoint": "http://localhost:3000/.oidc/request",
    "request_parameter_supported": false,
    "request_uri_parameter_supported": false,
    "introspection_endpoint": "http://localhost:3000/.oidc/token/introspection",
    "dpop_signing_alg_values_supported": [
        "RS256",
        "RS384",
        "RS512",
        "PS256",
        "PS384",
        "PS512",
        "ES256",
        "ES256K",
        "ES384",
        "ES512",
        "EdDSA"
    ],
    "revocation_endpoint": "http://localhost:3000/.oidc/token/revocation",
    "claim_types_supported": [
        "normal"
    ]
}

require "base64"
authString = "my-token_4141776e-b7ab-4d16-9be4-8062535f7e05:39f45dbe76ba16db7f338a75f2978b759c0dfeef9ca5a72bd4c9414ea054144982b7a4145581e6c8d714ca166fce135c550c58233f5242c68f6ccc141657b8a7"

enc   = Base64.strict_encode64(authString)
# enc = 'bXktdG9rZW5fNDE0MTc3NmUtYjdhYi00ZDE2LTliZTQtODA2MjUzNWY3ZTA1OjM5ZjQ1ZGJlNzZiYTE2ZGI3ZjMzOGE3NWYyOTc4Yjc1OWMwZGZlZWY5Y2E1YTcyYmQ0Yzk0MTRlYTA1NDE0NDk4MmI3YTQxNDU1ODFlNmM4ZDcxNGNhMTY2ZmNlMTM1YzU1MGM1ODIzM2Y1MjQyYzY4ZjZjY2MxNDE2NTdiOGE3'

require "dpop"
private = OpenSSL::PKey::RSA.new(2048)
# private = Dpop.generate_key_pair
# private = OpenSSL::PKey::RSA.new(private)
public = private.public_key.to_pem

public.to_pem = "-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWW2CHr4l2TtJ9/T0TxsSwkZ9b\nzUK1BuS7sXC6MqdTbVK+Z0ltOs3I5wBD6qvcGoCfOe3p5GrAFTik7e14ip1f29pO\nF7lOI/Op8QR3awgtlYvAZdrXWcDvfNPQ0+I54clCpsOjC+ah1xfR+zA+q6aNSXqk\nn+Q2pX/4H3/Kw1xomQIDAQAB\n-----END PUBLIC KEY-----\n" 
private.to_pem =  "-----BEGIN RSA PRIVATE KEY-----\nMIICXgIBAAKBgQDWW2CHr4l2TtJ9/T0TxsSwkZ9bzUK1BuS7sXC6MqdTbVK+Z0lt\nOs3I5wBD6qvcGoCfOe3p5GrAFTik7e14ip1f29pOF7lOI/Op8QR3awgtlYvAZdrX\nWcDvfNPQ0+I54clCpsOjC+ah1xfR+zA+q6aNSXqkn+Q2pX/4H3/Kw1xomQIDAQAB\nAoGANQTxAV6nr32bjtIeU0/swoeiVQCWKVSFKu+epE93F6mIt9OwU7YhxDlu1V2s\nGIrtmXSopht7U/trwU+gVxpiBink8gEIazdWXiB+Wb+4o3GGoAJw49jxAjvFOMsR\nwC0RSzhftIYS/unNICw6HwSMjw8/jCjqtR2/NY5lPrt9dqECQQDs4afUu4tTOv6X\nV2ZbIcDMRISjnlIw+/sOkxYSzh5zDiqFiCH+LI23dqEDSTYBdsoFCu/wo9d02+pH\nISWswt1tAkEA56hUTD02U76NfQtQU5z4bEIPjcpVkApMQepdsutv4QwC+QqIUl6f\nh3NMTMysA5yUro3I1ClAMo/6DCAmq/bYXQJBAJomXqk5QnlvMq4Z2ioD1QsYq5gu\nNx5ZXA8n+H1UVMxas6Eh7b0SEUcKk80nn1VkkCKn82yNsnABjHutPm8mgCECQQC4\nWEN8x9lLmv+M2kv5vZgSzh8CfljIXumAKriVgLVvKNfUxoTkx1e7ugylsNnRpfDL\nVxjRfGIR2nDo5Uzg23YhAkEAj58bKTTFwqXjKzvFkfZFpb5Y0SbLRK+WKIPcdjRv\nmjIib/XmkUFAZF88rGKIbWMikTeY3SoPsMMAVWiDFmmk/w==\n-----END RSA PRIVATE KEY-----\n" 

proof = Dpop.get_proof_with_key(private.to_pem, htu: "http://localhost:3000/.oidc/token", htm: "POST")

# proof => "eyJhbGciOiJSUzI1NiIsInR5cCI6ImRwb3Arand0IiwiandrIjp7Imt0eSI6IlJTQSIsIm4iOiIxbHRnaDYtSmRrN1NmZjA5RThiRXNKR2ZXODFDdFFia3U3Rnd1aktuVTIxU3ZtZEpiVHJOeU9jQVEtcXIzQnFBbnpudDZlUnF3QlU0cE8zdGVJcWRYOXZhVGhlNVRpUHpxZkVFZDJzSUxaV0x3R1hhMTFuQTczelQwTlBpT2VISlFxYkRvd3Ztb2RjWDBmc3dQcXVtalVsNnBKX2tOcVZfLUI5X3lzTmNhSmsiLCJlIjoiQVFBQiJ9fQ.eyJodHUiOiJodHRwOi8vbG9jYWxob3N0OjMwMDAvLm9pZGMvdG9rZW4iLCJodG0iOiJQT1NUIiwiaWF0IjoxNzIzMjEyNTc0LCJqdGkiOiIyZjg0MzUyZi00YTRhLTQ1NzgtOWRhMi1lOWVkNzdlYjk3MmQifQ.vK2s9dQ7CkeIDZTxSG5SslTFUlqzGJdFg8-WCSUHE7MGU6aXrzIDE_uMGrlZNcx-rRWx4lfOVOe2omHwE1Q7yIzhN2WsfXNR9yTvvY0cE6EcfCggtZ4Pu41BRjm_dlBy_tkwRhn-dvV1h_i_xX9xzV8r7SWzKqlvCApsaLw5wyg" 


resp = RestClient::Request.new({
method: :post,
 url: 'http://localhost:3000/.oidc/token',
payload: 'grant_type=client_credentials&scope=webid',
headers: {content_type: 'application/x-www-form-urlencoded', 'dpop' => proof, Authorization:"Basic #{enc}"}
 }).execute


# "{\"access_token\":\"eyJhbGciOiJFUzI1NiIsInR5cCI6ImF0K2p3dCIsImtpZCI6InRkWWJjVC1xbHg5RlNwMGtJWlFGa1BXSWVxeWhqMjVvTHlLel91TWVTZVEifQ.eyJ3ZWJpZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9tYXJrdy9wcm9maWxlL2NhcmQjbWUiLCJqdGkiOiJhbTV2NXUyM3FHeFZIc2UzX1pnaFQiLCJzdWIiOiJteS10b2tlbl80MTQxNzc2ZS1iN2FiLTRkMTYtOWJlNC04MDYyNTM1ZjdlMDUiLCJpYXQiOjE3MjMyMTQxNjAsImV4cCI6MTcyMzIxNDc2MCwiY2xpZW50X2lkIjoibXktdG9rZW5fNDE0MTc3NmUtYjdhYi00ZDE2LTliZTQtODA2MjUzNWY3ZTA1IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwLyIsImF1ZCI6InNvbGlkIiwiY25mIjp7ImprdCI6ImE1aC1MYUd3YVhRbElVdmZWakhhVDNPa0Y1TlFlQ0R5YklleWR6WmZ3RWsifX0.LB13ISPdjuVCBjhKnzswrkiRs9osLlQWxlBiAmgDSWXgIvJULakVx58Zfw5beMpIzrcMacJkqIRcVqQUO3XFnA\",\"expires_in\":600,\"token_type\":\"DPoP\"}" 

token = JSON.parse(resp.body)["access_token"]

 resp2 = RestClient::Request.new({
    method: :post,
     url: 'http://localhost:3000/.account/account/4b6de802-29e1-498b-94cd-87092cca3166/pod/',
    payload: 'this is a test',
    headers: {content_type: 'text/plain', 'dpop' => proof, Authorization:"Bearer #{token}"}
     }).execute

curl -v -X POST \
-H "Authorization: Basic bXktdG9rZW5fNDE0MTc3NmUtYjdhYi00ZDE2LTliZTQtODA2MjUzNWY3ZTA1OjM5ZjQ1ZGJlNzZiYTE2ZGI3ZjMzOGE3NWYyOTc4Yjc1OWMwZGZlZWY5Y2E1YTcyYmQ0Yzk0MTRlYTA1NDE0NDk4MmI3YTQxNDU1ODFlNmM4ZDcxNGNhMTY2ZmNlMTM1YzU1MGM1ODIzM2Y1MjQyYzY4ZjZjY2MxNDE2NTdiOGE3" \
-H "Content-type: application/x-www-form-urlencoded" \
-H "dpop: eyJhbGciOiJSUzI1NiIsInR5cCI6ImRwb3Arand0IiwiandrIjp7Imt0eSI6IlJTQSIsIm4iOiIxbHRnaDYtSmRrN1NmZjA5RThiRXNKR2ZXODFDdFFia3U3Rnd1aktuVTIxU3ZtZEpiVHJOeU9jQVEtcXIzQnFBbnpudDZlUnF3QlU0cE8zdGVJcWRYOXZhVGhlNVRpUHpxZkVFZDJzSUxaV0x3R1hhMTFuQTczelQwTlBpT2VISlFxYkRvd3Ztb2RjWDBmc3dQcXVtalVsNnBKX2tOcVZfLUI5X3lzTmNhSmsiLCJlIjoiQVFBQiJ9fQ.eyJodHUiOiJodHRwOi8vbG9jYWxob3N0OjMwMDAvLm9pZGMvdG9rZW4iLCJodG0iOiJQT1NUIiwiaWF0IjoxNzIzMjEyNTc0LCJqdGkiOiIyZjg0MzUyZi00YTRhLTQ1NzgtOWRhMi1lOWVkNzdlYjk3MmQifQ.vK2s9dQ7CkeIDZTxSG5SslTFUlqzGJdFg8-WCSUHE7MGU6aXrzIDE_uMGrlZNcx-rRWx4lfOVOe2omHwE1Q7yIzhN2WsfXNR9yTvvY0cE6EcfCggtZ4Pu41BRjm_dlBy_tkwRhn-dvV1h_i_xX9xzV8r7SWzKqlvCApsaLw5wyg"  \
-d 'grant_type=client_credentials&scope=webid' \
    "http://localhost:3000/.oidc/token"